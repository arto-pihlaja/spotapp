generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum SportType {
  WING_FOIL
  WINDSURF
  KITE
  OTHER
}

enum SessionType {
  NOW
  PLANNED
}

enum AuditActionType {
  USER_BLOCKED
  USER_UNBLOCKED
  SPOT_DELETED
  WIKI_REVERTED
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  photoUrl     String?  @map("photo_url")
  externalLink String?  @map("external_link")
  role         UserRole @default(USER)
  isBlocked    Boolean  @default(false) @map("is_blocked")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  invitationCodes        InvitationCode[]
  spots                  Spot[]
  wikiContents           WikiContent[]
  sessions               Session[]
  conditionReports       ConditionReport[]
  conditionConfirmations ConditionConfirmation[]
  auditLogs              AuditLog[]

  @@map("users")
}

model InvitationCode {
  id          String    @id @default(uuid())
  code        String    @unique
  maxUses     Int       @map("max_uses")
  currentUses Int       @default(0) @map("current_uses")
  expiresAt   DateTime? @map("expires_at")
  createdBy   String    @map("created_by")

  creator User @relation(fields: [createdBy], references: [id])

  @@map("invitation_codes")
}

model Spot {
  id        String   @id @default(uuid())
  name      String
  latitude  Float
  longitude Float
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  creator          User              @relation(fields: [createdBy], references: [id])
  wikiContent      WikiContent?
  sessions         Session[]
  conditionReports ConditionReport[]

  @@map("spots")
}

model WikiContent {
  id        String   @id @default(uuid())
  spotId    String   @unique @map("spot_id")
  content   String
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  spot   Spot @relation(fields: [spotId], references: [id])
  editor User @relation(fields: [updatedBy], references: [id])

  @@map("wiki_contents")
}

model Session {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  spotId      String      @map("spot_id")
  type        SessionType
  sportType   SportType   @map("sport_type")
  scheduledAt DateTime?   @map("scheduled_at")
  expiresAt   DateTime?   @map("expires_at")
  createdAt   DateTime    @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
  spot Spot @relation(fields: [spotId], references: [id])

  @@map("sessions")
}

model ConditionReport {
  id            String   @id @default(uuid())
  spotId        String   @map("spot_id")
  userId        String   @map("user_id")
  waveHeight    Float?   @map("wave_height")
  windSpeed     Float?   @map("wind_speed")
  windDirection String?  @map("wind_direction")
  createdAt     DateTime @default(now()) @map("created_at")

  spot          Spot                    @relation(fields: [spotId], references: [id])
  user          User                    @relation(fields: [userId], references: [id])
  confirmations ConditionConfirmation[]

  @@map("condition_reports")
}

model ConditionConfirmation {
  id                String @id @default(uuid())
  conditionReportId String @map("condition_report_id")
  userId            String @map("user_id")

  conditionReport ConditionReport @relation(fields: [conditionReportId], references: [id])
  user            User            @relation(fields: [userId], references: [id])

  @@unique([conditionReportId, userId])
  @@map("condition_confirmations")
}

model AuditLog {
  id         String          @id @default(uuid())
  action     AuditActionType
  targetType String          @map("target_type")
  targetId   String          @map("target_id")
  adminId    String          @map("admin_id")
  metadata   Json?
  createdAt  DateTime        @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id])

  @@map("audit_logs")
}
